# Setting Up Maddy Mail Server with Namecheap Domain

This guide walks through the process of configuring your Namecheap domain for use with a Maddy mail server.

## Prerequisites

- A domain registered with Namecheap
- A server with a static IP address where Maddy is installed
- Maddy mail server running in Docker (as per the docker-compose.yml)

## Step 1: Gather Your Information

Before configuring DNS records, make sure you have:

- Your server's public IP address
- Your chosen hostname (e.g., `mx.yourdomain.com`)
- DKIM key generated by Maddy

To get your DKIM key:
```
docker exec maddy cat /data/dkim_keys/default.dns
```

## Step 2: Access Namecheap DNS Settings

1. Log in to your Namecheap account
2. Go to "Domain List" and click "Manage" next to your domain
3. Navigate to the "Advanced DNS" tab

## Step 3: Configure DNS Records for Email

### MX Record

1. In the Advanced DNS section, add a new record:
   - Type: `MX`
   - Host: `@` (represents the root domain)
   - Value: `mx.yourdomain.com` (your mail server hostname)
   - Priority: `10`
   - TTL: `Automatic` or `1 hour`

### A Record for Mail Server

1. Add an A record for your mail server:
   - Type: `A`
   - Host: `mx` (this will create mx.yourdomain.com)
   - Value: `[Your Server IP Address]`
   - TTL: `Automatic` or `1 hour`

### SPF Record

1. Add an SPF record:
   - Type: `TXT`
   - Host: `@`
   - Value: `v=spf1 mx ~all`
   - TTL: `Automatic` or `1 hour`

### DKIM Record

1. Add the DKIM record using the key generated by Maddy:
   - Type: `TXT`
   - Host: `default._domainkey`
   - Value: `[Content from the DKIM key file]`
   - TTL: `Automatic` or `1 hour`

### DMARC Record

1. Add a DMARC record:
   - Type: `TXT`
   - Host: `_dmarc`
   - Value: `v=DMARC1; p=quarantine; rua=mailto:postmaster@yourdomain.com`
   - TTL: `Automatic` or `1 hour`

## Step 4: Configure Reverse DNS (PTR Record)

Note: Reverse DNS must be set up with your hosting provider, not Namecheap. This is a critical step to avoid your emails being marked as spam.

1. Contact your hosting provider/VPS provider
2. Request that they set a reverse DNS (PTR) record for your IP address
3. The PTR should point to your mail server hostname (e.g., `mx.yourdomain.com`)

## Step 5: Update Maddy Configuration

Update your docker-compose.yml to use your actual domain:

```yaml
services:
  maddy:
    environment:
      - MADDY_HOSTNAME=mx.yourdomain.com
      - MADDY_DOMAIN=yourdomain.com
    # other settings...
```

## Step 6: Obtain SSL Certificates

For production use, you'll need proper SSL certificates. Let's Encrypt is recommended:

1. Stop your Maddy container
2. Use certbot to obtain certificates:
   ```
   certbot certonly --standalone -d mx.yourdomain.com
   ```
3. Copy the certificates to your Maddy TLS directory:
   ```
   cp /etc/letsencrypt/live/mx.yourdomain.com/fullchain.pem /path/to/maddy/tls/
   cp /etc/letsencrypt/live/mx.yourdomain.com/privkey.pem /path/to/maddy/tls/
   ```
4. Restart your Maddy container

## Step 7: Testing Your Mail Server

### Verify DNS Records

Use online tools to verify your DNS configuration:
- [MXToolbox](https://mxtoolbox.com/)
- [Mail Tester](https://www.mail-tester.com/)

### Create a Test User

Use the maddy-utils.js script to create a test user:
```
node maddy-utils.js
```

Select "create-user" and follow the prompts.

### Send a Test Email

1. Use maddy-utils.js to send a test email
2. Alternatively, configure a mail client (Thunderbird, Outlook, etc.) with your new account

## Troubleshooting

### Common Issues

1. **Emails marked as spam or rejected**:
   - Verify SPF, DKIM, and DMARC records
   - Check if reverse DNS (PTR) is properly configured
   - Ensure your server is not on any blacklists

2. **Connection timeouts or refused**:
   - Check if ports 25, 465, 587, 143, and 993 are open in your firewall
   - Ensure your ISP isn't blocking port 25 (common with residential IPs)

3. **TLS certificate errors**:
   - Verify certificate paths in Maddy configuration
   - Check certificate expiration dates

### Useful Commands

Check Maddy logs:
```
docker logs maddy
```

Test SMTP connection:
```
telnet mx.yourdomain.com 25
```

## Additional Resources

- [Namecheap DNS Documentation](https://www.namecheap.com/support/knowledgebase/article.aspx/434/2237/how-do-i-set-up-host-records-for-a-domain/)
- [Maddy Mail Server Documentation](https://maddy.email/)
- [Email Best Practices](https://www.mail-tester.com/spf-dkim-check)
